# Multi-Camera Face Recognition Pipeline
# Uses nvmultiurisrcbin for dynamic camera add/remove via REST API
#
# Add camera:
#   curl -X POST 'http://localhost:9000/api/v1/stream/add' \
#     -H 'Content-Type: application/json' \
#     -d '{"value":{"camera_id":"cam1","camera_url":"rtsp://...","change":"camera_add"}}'
#
# Remove camera (camera_url required):
#   curl -X POST 'http://localhost:9000/api/v1/stream/remove' \
#     -H 'Content-Type: application/json' \
#     -d '{"value":{"camera_id":"cam1","camera_url":"file:///path/to/video.mp4","change":"camera_remove"}}'

# =============================================================================
# Recognition Settings
# =============================================================================
recognition:
    features_json: "${FEATURES_JSON:/home/mq/disk2T/quangnv/face/data/face/features.json}"
    l2_threshold: 1.0
    min_streak: 3
    skip_reid: 3
    reid_interval: 30
    min_face_size: 50

# =============================================================================
# Pipeline Definition
# =============================================================================
pipeline:
    name: multi-camera-pipeline

    source:
        type: nvmultiurisrcbin
        name: multi_src
        properties:
            # Initial cameras (empty = add via REST)
            uri-list: ""
            sensor-id-list: ""

            # Capacity (set based on expected max cameras)
            max-batch-size: "${MAX_CAMERAS:16}"

            # REST API
            ip-address: "${REST_HOST:0.0.0.0}"
            port: "${REST_PORT:9000}"

            # Pipeline behavior
            drop-pipeline-eos: true
            live-source: 1

            # Memory type: 0 = default
            nvbuf-memory-type: 0
            num-extra-surfaces: 4

            # Disable passthrough for nvvideoconvert inside nvmultiurisrcbin
            disable-passthrough: true

            # RTSP settings
            rtsp-reconnect-interval: 5
            rtsp-reconnect-attempts: -1
            select-rtp-protocol: 4
            latency: 200

            # Output format (muxer properties)
            width: 1920
            height: 1080
            batched-push-timeout: 33333

    # No muxer section - nvmultiurisrcbin includes it

    elements:
        # Queue to handle batched buffers from nvmultiurisrcbin
        - type: queue
          properties:
              max-size-buffers: 10
              leaky: 2

        # nvinfer expects RGBA but nvmultiurisrcbin can output NV12
        # Let nvinfer handle the conversion internally
        - type: nvinfer
          name: pgie
          config_file: "${PGIE_CONFIG:data/face/models/scrfd640/infer.txt}"

        - type: nvtracker
          name: tracker
          config_file: "${TRACKER_CONFIG:data/face/models/NvDCF/config_tracker.txt}"
          probes:
              src: tracker_probe

        - type: nvinfer
          name: sgie
          config_file: "${SGIE_CONFIG:data/face/models/arcface/infer.txt}"
          probes:
              src: sgie_probe

        - type: queue
          properties:
              max-size-buffers: 3
              leaky: 2

        # Tile multiple streams into single view BEFORE drawing OSD
        # This ensures bounding boxes are drawn at correct tile positions
        - type: nvmultistreamtiler
          name: tiler
          properties:
              rows: 2
              columns: 2
              width: 1920
              height: 1080

        # Draw bounding boxes AFTER tiling so coordinates are correct
        - type: nvdsosd
          properties:
              process-mode: 0
              display-text: 1
          probes:
              src: fps_probe

# =============================================================================
# Sink Configuration
# =============================================================================
sink:
    type: "${OUTPUT_MODE:fakesink}"

    webrtc:
        ws_url: "${WS_URL:ws://192.168.6.16:8555}"
        peer_id: "1"

    fakesink:
        sync: false

# =============================================================================
# Camera Management
# =============================================================================
camera:
    rest_host: "${REST_HOST:localhost}"
    rest_port: "${REST_PORT:9000}"
    max_cameras: "${MAX_CAMERAS:16}"

# =============================================================================
# Optional: Initial cameras to add on startup
# =============================================================================
# cameras:
#     - id: cam_entrance
#       url: "rtsp://admin:pass@192.168.1.100:554/stream1"
#       name: "Entrance Camera"
